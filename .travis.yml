sudo: required
language: java
dist: trusty

services:
- docker

env:
  global:
  - DOCKER_VERSION=1.11.1-0~trusty
  - DOCKER_COMPOSE_VERSION=1.7.0
  - COMMIT=${TRAVIS_COMMIT::8}
  # DOCKER_USERNAME=<docker username>
  - secure: "umlGRhDNOovzsgqHTCz7TRSC0RV/Vgfvqo/NdrgFtw2J+N29miGTBP19oOS8Vz5ybdd+Q7Kvh3gtraFQn5q2Kccn2s4i6gcMwcjp3dHNwSBNZuuPz8JpO5UEtMGhqnKnUNgx8HfZx7AhQY3JpVBdlwBNgXpLbG6O21wQoyxk0PPwQP9qe5HS475lhUUi45/UX9F8OSsDY6fmrDf7M+lZ8KU13ZMoPBW5qC/BpJGKwo5KIj6Yq58m5AMWWT51qKcPoX/J0G6SWKYrvFKSZpDTtfzqD2vsuUWEC5ZeiZeQHK274/0OMs6aJ7qU1Q3CUED086e6AZnGTz4GXolilKfpSUrc2IEUBY2ROKCVYh22NL/WdHQhpH9gfVNA+pK+9M/NdHKflqk01Hhnszwxk4VkDjBlbhE2W/XmvKbUGxYBHtjS8FNGRxcQVXJ1OgCFAL+jJ5O8XpkENuOGyOQoh5JqK+fCNIdH1oAWjt2oLF9ra8Tn5h1z4dp0Aan0xZfzSn4a4PiUV8SJ4+S4eAwexqTD2QhAgv0+9IcK0REzBlqbFSCRx8ysILr3KEJqTxbY5JJThmw6OVf1+BDsh+egaIb2hq5gBCvXmo3F+346UxdqIn2+qJ4/p83hJAZRFMrzV9MPnaoSYZgTZ8wW8JfIeHvOtyCKSvnOsMtjaAR0JjIajFo="
  # DOCKER_PASSWORD=<docker password>
  - secure: "r1jBgwOr9Oa0sBaT+ZA9ulhwChjHqR8hMbb7a3J3ifIqBQVWODFpnoXkaWX5BBTASnwY4Qi/lotbXv8uXS/f+nIKReqV5XLvWj9BE3mPouinUx42MP1QAlTs93GQTmHAW2L7Pwoa5RHXraZHHtsJP2Vjx23MTo1yJ3ZlCJNgnoPA9upMglQQ6CIhREErNIbhRUXRAp8ePEEdFvd4lV6NitbzUj5pc2RrwyWJYKhYPsk9kARJIH6JC7JuH9TtLZBNt/FqLtdMW38GureVYSYA8JNjdY0MglEgsbsLWfH0C1A3Bohb/uF7WVH4ktxqW39L3oNICeDl5/YxJ7inAA1Kns40nm3CY7rBEFX97c/enoKZP86E9mEmIBtCtJYrNGRJ14/iOsdcllgXcuA136iVAVUwpu/Gl9LsvAIrfQvCsXqN9SK2b/O046oPmFBD0keOFKBYMtHpIisvjlvnLzbTsLM8nv6meAbY5vAoFNvIuuQkbOgV2B0McfHc9eFJcvsbLh6fxJwtkMiWN81/YH9G54xolM0jTT9DZAHpsPR0W1IgJ1qSBXxgwUy+agWPvUJcBlrjCj1ik/Hg5eKC6GlkIHjICS4DgxONaNpIrmO7B/6H1bYjcZCovqgge29xskoDUvdnUcMuTH3agRfJAINtZcH+ct6xMsvauBKq6nVsMpY="

before_cache:
- rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"

stages:
  - name: test
  - name: deploy
    if: NOT (type IN (pull_request))

jobs:
  include:
    - stage: test
      env: [ NAME=unit-test ]
      script: make test-travis
      after_success: make coverage

    - stage: test
      env: [ NAME=crossdock ]
      script: make crossdock-fresh

    - stage: deploy
      env: [ NAME=release ]
      script: make release
      if: tag =~ /^release\/v.[\d\.]+(\-.*)?$/ # matches "release/v0.31.0" or "release/v0.31.0-RC1"

    - stage: deploy
      env: [ NAME=deploy-crossdock-to-dockerhub ]
      script: ./travis/publish-crossdock.sh
